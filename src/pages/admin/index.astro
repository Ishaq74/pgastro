---
import Layout from '../../layouts/Layout.astro';

// V√©rifier que l'utilisateur est admin (middleware s'occupe de la v√©rification)
const user = Astro.locals.user;
const session = Astro.locals.session;

if (!user || !session) {
  return Astro.redirect('/login');
}
---

<Layout title="Administration">
  <main class="admin-container">
    <header class="admin-header">
      <h1>üéõÔ∏è Panneau d'Administration</h1>
      <p>Bienvenue, <strong>{user.name}</strong> !</p>
    </header>

    <div class="admin-grid">
      <div class="admin-card">
        <h2>üë• Gestion des Utilisateurs</h2>
        <p>G√©rer les comptes utilisateurs, les r√¥les et les permissions</p>
        <a href="/admin/utilisateurs" class="btn btn-primary">Voir les utilisateurs</a>
      </div>

      <div class="admin-card" id="stats-card">
        <h2>üìä Statistiques</h2>
        <div id="stats-content">
          <p>Chargement des statistiques...</p>
        </div>
      </div>

      <div class="admin-card">
        <h2>‚öôÔ∏è Configuration</h2>
        <p>Param√®tres syst√®me et configuration SMTP</p>
        <a href="/admin/config" class="btn btn-secondary">Configuration</a>
      </div>

      <div class="admin-card">
        <h2>üîê S√©curit√©</h2>
        <p>Logs d'audit et √©v√©nements de s√©curit√©</p>
        <a href="/admin/security" class="btn btn-secondary">S√©curit√©</a>
      </div>
    </div>

    <div class="admin-actions">
      <a href="/profile" class="btn btn-outline">Mon Profil</a>
      <button id="logout-btn" class="btn btn-secondary">D√©connexion</button>
    </div>
  </main>
</Layout>

<script>
  import { authClient } from '../../lib/auth-client';

  async function loadStats() {
    try {
      const response = await fetch('/api/admin/stats');
      if (response.ok) {
        const data = await response.json();
        const statsContent = document.getElementById('stats-content');
        if (statsContent && data.success) {
          statsContent.innerHTML = `
            <div class="stats-grid">
              <div class="stat">
                <span class="stat-number">${data.totalUsers || 0}</span>
                <span class="stat-label">Utilisateurs</span>
              </div>
              <div class="stat">
                <span class="stat-number">${data.admins || 0}</span>
                <span class="stat-label">Administrateurs</span>
              </div>
              <div class="stat">
                <span class="stat-number">${data.verifiedUsers || 0}</span>
                <span class="stat-label">Comptes v√©rifi√©s</span>
              </div>
            </div>
          `;
        }
      }
    } catch (error) {
      console.error('Erreur lors du chargement des stats:', error);
      const statsContent = document.getElementById('stats-content');
      if (statsContent) {
        statsContent.innerHTML = '<p class="error">Erreur de chargement</p>';
      }
    }
  }

  async function logout() {
    try {
      await authClient.signOut({
        fetchOptions: {
          onSuccess: () => {
            window.location.href = '/';
          }
        }
      });
    } catch (error) {
      console.error('Erreur lors de la d√©connexion:', error);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadStats();
    document.getElementById('logout-btn')?.addEventListener('click', logout);
  });
</script>

<style>
  .admin-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
  }

  .admin-header {
    text-align: center;
    margin-bottom: 3rem;
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    color: white;
    padding: 2rem;
    border-radius: 12px;
  }

  .admin-header h1 {
    margin: 0 0 0.5rem 0;
    font-size: 2.5rem;
  }

  .admin-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
    margin-bottom: 3rem;
  }

  .admin-card {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    border: 1px solid #e5e7eb;
  }

  .admin-card h2 {
    margin: 0 0 1rem 0;
    color: #374151;
    font-size: 1.25rem;
  }

  .admin-card p {
    color: #6b7280;
    margin-bottom: 1rem;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
  }

  .stat {
    text-align: center;
    padding: 0.5rem;
  }

  .stat-number {
    display: block;
    font-size: 1.5rem;
    font-weight: bold;
    color: #4f46e5;
  }

  .stat-label {
    display: block;
    font-size: 0.875rem;
    color: #6b7280;
  }

  .admin-actions {
    display: flex;
    justify-content: center;
    gap: 1rem;
  }

  .btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 4px;
    text-decoration: none;
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.2s;
  }

  .btn-primary {
    background: #4f46e5;
    color: white;
  }

  .btn-primary:hover {
    background: #4338ca;
  }

  .btn-secondary {
    background: #6b7280;
    color: white;
  }

  .btn-secondary:hover {
    background: #4b5563;
  }

  .btn-outline {
    background: transparent;
    color: #4f46e5;
    border: 1px solid #4f46e5;
  }

  .btn-outline:hover {
    background: #4f46e5;
    color: white;
  }

  .error {
    color: #dc2626;
    font-style: italic;
  }
</style>